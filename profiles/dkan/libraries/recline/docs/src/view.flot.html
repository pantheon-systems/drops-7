<!DOCTYPE html>

<html>
<head>
  <title>view.flot.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="backend.dataproxy.html">
                  backend.dataproxy.js
                </a>
              
                
                <a class="source" href="backend.memory.html">
                  backend.memory.js
                </a>
              
                
                <a class="source" href="ecma-fixes.html">
                  ecma-fixes.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="view.flot.html">
                  view.flot.js
                </a>
              
                
                <a class="source" href="view.graph.html">
                  view.graph.js
                </a>
              
                
                <a class="source" href="view.grid.html">
                  view.grid.js
                </a>
              
                
                <a class="source" href="view.map.html">
                  view.map.js
                </a>
              
                
                <a class="source" href="view.multiview.html">
                  view.multiview.js
                </a>
              
                
                <a class="source" href="view.slickgrid.html">
                  view.slickgrid.js
                </a>
              
                
                <a class="source" href="view.timeline.html">
                  view.timeline.js
                </a>
              
                
                <a class="source" href="widget.facetviewer.html">
                  widget.facetviewer.js
                </a>
              
                
                <a class="source" href="widget.fields.html">
                  widget.fields.js
                </a>
              
                
                <a class="source" href="widget.filtereditor.html">
                  widget.filtereditor.js
                </a>
              
                
                <a class="source" href="widget.pager.html">
                  widget.pager.js
                </a>
              
                
                <a class="source" href="widget.queryeditor.html">
                  widget.queryeditor.js
                </a>
              
                
                <a class="source" href="widget.valuefilter.html">
                  widget.valuefilter.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>view.flot.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*jshint multistr:true */</span>

<span class="hljs-keyword">this</span>.recline = <span class="hljs-keyword">this</span>.recline || {};
<span class="hljs-keyword">this</span>.recline.View = <span class="hljs-keyword">this</span>.recline.View || {};

(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($, my)</span> </span>{
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="graph-view-for-a-dataset-using-flot-graphing-library-">Graph view for a Dataset using Flot graphing library.</h2>
<p>Initialization arguments (in a hash in first parameter):</p>
<ul>
<li>model: recline.Model.Dataset</li>
<li><p>state: (optional) configuration hash of form:</p>
<pre><code> {
   group: {column name <span class="hljs-keyword">for</span> x-axis},
   series: [{column name <span class="hljs-keyword">for</span> series A}, {column name series B}, ... ],
   <span class="hljs-comment">// options are: lines, points, lines-and-points, bars, columns</span>
   graphType: <span class="hljs-string">'lines'</span>,
   graphOptions: {custom [flot options]}
 }
</code></pre></li>
</ul>
<p>NB: should <em>not</em> provide an el argument to the view but must let the view
generate the element itself (you can then append view.el to the DOM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>my.Flot = Backbone.View.extend({
  template: <span class="hljs-string">' \
    &lt;div class="recline-flot"&gt; \
      &lt;div class="panel graph" style="display: block;"&gt; \
        &lt;div class="js-temp-notice alert alert-warning alert-block"&gt; \
          &lt;h3 class="alert-heading"&gt;Hey there!&lt;/h3&gt; \
          &lt;p&gt;There\'s no graph here yet because we don\'t know what fields you\'d like to see plotted.&lt;/p&gt; \
          &lt;p&gt;Please tell us by &lt;strong&gt;using the menu on the right&lt;/strong&gt; and a graph will automatically appear.&lt;/p&gt; \
        &lt;/div&gt; \
      &lt;/div&gt; \
    &lt;/div&gt; \
'</span>,

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.graphColors = [<span class="hljs-string">"#edc240"</span>, <span class="hljs-string">"#afd8f8"</span>, <span class="hljs-string">"#cb4b4b"</span>, <span class="hljs-string">"#4da74d"</span>, <span class="hljs-string">"#9440ed"</span>];

    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'render'</span>, <span class="hljs-string">'redraw'</span>, <span class="hljs-string">'_toolTip'</span>, <span class="hljs-string">'_xaxisLabel'</span>);
    <span class="hljs-keyword">this</span>.needToRedraw = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.model, <span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.render);
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.model.fields, <span class="hljs-string">'reset add'</span>, <span class="hljs-keyword">this</span>.render);
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.model.records, <span class="hljs-string">'reset add'</span>, <span class="hljs-keyword">this</span>.redraw);
    <span class="hljs-keyword">var</span> stateData = _.extend({
        group: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>so that at least one series chooser box shows up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        series: [],
        graphType: <span class="hljs-string">'lines-and-points'</span>
      },
      options.state
    );
    <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">new</span> recline.Model.ObjectState(stateData);
    <span class="hljs-keyword">this</span>.previousTooltipPoint = {x: <span class="hljs-literal">null</span>, y: <span class="hljs-literal">null</span>};
    <span class="hljs-keyword">this</span>.editor = <span class="hljs-keyword">new</span> my.FlotControls({
      model: <span class="hljs-keyword">this</span>.model,
      state: <span class="hljs-keyword">this</span>.state.toJSON()
    });
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.editor.state, <span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      self.state.set(self.editor.state.toJSON());
      self.redraw();
    });
    <span class="hljs-keyword">this</span>.elSidebar = <span class="hljs-keyword">this</span>.editor.$el;
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> tmplData = <span class="hljs-keyword">this</span>.model.toTemplateJSON();
    <span class="hljs-keyword">var</span> htmls = Mustache.render(<span class="hljs-keyword">this</span>.template, tmplData);
    <span class="hljs-keyword">this</span>.$el.html(htmls);
    <span class="hljs-keyword">this</span>.$graph = <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.panel.graph'</span>);
    <span class="hljs-keyword">this</span>.$graph.on(<span class="hljs-string">"plothover"</span>, <span class="hljs-keyword">this</span>._toolTip);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  remove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.editor.remove();
    Backbone.View.prototype.remove.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  redraw: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>There are issues generating a Flot graph if either:</p>
<ul>
<li>The relevant div that graph attaches to his hidden at the moment of creating the plot — Flot will complain with
Uncaught Invalid dimensions for plot, width = 0, height = 0</li>
<li>There is no data for the plot — either same error or may have issues later with errors like ‘non-existent node-value’</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> areWeVisible = !jQuery.expr.filters.hidden(<span class="hljs-keyword">this</span>.el);
    <span class="hljs-keyword">if</span> ((!areWeVisible || <span class="hljs-keyword">this</span>.model.records.length === <span class="hljs-number">0</span>)) {
      <span class="hljs-keyword">this</span>.needToRedraw = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>check we have something to plot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'group'</span>) &amp;&amp; <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'series'</span>)) {
      <span class="hljs-keyword">var</span> series = <span class="hljs-keyword">this</span>.createSeries();
      <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>.getGraphOptions(<span class="hljs-keyword">this</span>.state.attributes.graphType, series[<span class="hljs-number">0</span>].data.length);
      <span class="hljs-keyword">this</span>.plot = $.plot(<span class="hljs-keyword">this</span>.$graph, series, options);
    }
  },

  show: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>because we cannot redraw when hidden we may need to when becoming visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.needToRedraw) {
      <span class="hljs-keyword">this</span>.redraw();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>infoboxes on mouse hover on points/bars etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _toolTip: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event, pos, item)</span> </span>{
    <span class="hljs-keyword">if</span> (item) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.previousTooltipPoint.x !== item.dataIndex ||
          <span class="hljs-keyword">this</span>.previousTooltipPoint.y !== item.seriesIndex) {
        <span class="hljs-keyword">this</span>.previousTooltipPoint.x = item.dataIndex;
        <span class="hljs-keyword">this</span>.previousTooltipPoint.y = item.seriesIndex;
        $(<span class="hljs-string">"#recline-flot-tooltip"</span>).remove();

        <span class="hljs-keyword">var</span> x = item.datapoint[<span class="hljs-number">0</span>].toFixed(<span class="hljs-number">2</span>),
            y = item.datapoint[<span class="hljs-number">1</span>].toFixed(<span class="hljs-number">2</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.attributes.graphType === <span class="hljs-string">'bars'</span>) {
          x = item.datapoint[<span class="hljs-number">1</span>].toFixed(<span class="hljs-number">2</span>),
          y = item.datapoint[<span class="hljs-number">0</span>].toFixed(<span class="hljs-number">2</span>);
        }

        <span class="hljs-keyword">var</span> content = _.template(<span class="hljs-string">'&lt;%= group %&gt; = &lt;%= x %&gt;, &lt;%= series %&gt; = &lt;%= y %&gt;'</span>, {
          group: <span class="hljs-keyword">this</span>.state.attributes.group,
          x: <span class="hljs-keyword">this</span>._xaxisLabel(x),
          series: item.series.label,
          y: y
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>use a different tooltip location offset for bar charts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> xLocation, yLocation;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.attributes.graphType === <span class="hljs-string">'bars'</span>) {
          xLocation = item.pageX + <span class="hljs-number">15</span>;
          yLocation = item.pageY - <span class="hljs-number">10</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.attributes.graphType === <span class="hljs-string">'columns'</span>) {
          xLocation = item.pageX + <span class="hljs-number">15</span>;
          yLocation = item.pageY;
        } <span class="hljs-keyword">else</span> {
          xLocation = item.pageX + <span class="hljs-number">10</span>;
          yLocation = item.pageY - <span class="hljs-number">20</span>;
        }

        $(<span class="hljs-string">'&lt;div id="recline-flot-tooltip"&gt;'</span> + content + <span class="hljs-string">'&lt;/div&gt;'</span>).css({
            top: yLocation,
            left: xLocation
        }).appendTo(<span class="hljs-string">"body"</span>).fadeIn(<span class="hljs-number">200</span>);
      }
    } <span class="hljs-keyword">else</span> {
      $(<span class="hljs-string">"#recline-flot-tooltip"</span>).remove();
      <span class="hljs-keyword">this</span>.previousTooltipPoint.x = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.previousTooltipPoint.y = <span class="hljs-literal">null</span>;
    }
  },

  _xaxisLabel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._groupFieldIsDateTime()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>oddly x comes through as milliseconds <em>string</em> (rather than int
or float) so we have to reparse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      x = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">parseFloat</span>(x)).toLocaleDateString();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xvaluesAreIndex) {
      x = <span class="hljs-built_in">parseInt</span>(x, <span class="hljs-number">10</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>HACK: deal with bar graph style cases where x-axis items were strings
In this case x at this point is the index of the item in the list of
records not its actual x-axis value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      x = <span class="hljs-keyword">this</span>.model.records.models[x].get(<span class="hljs-keyword">this</span>.state.attributes.group);
    }

    <span class="hljs-keyword">return</span> x;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="getgraphoptions">getGraphOptions</h3>
<p>Get options for Flot Graph</p>
<p>needs to be function as can depend on state</p>
<p>@param typeId graphType id (lines, lines-and-points etc)
@param numPoints the number of points that will be plotted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getGraphOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(typeId, numPoints)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> groupFieldIsDateTime = self._groupFieldIsDateTime();
    <span class="hljs-keyword">var</span> xaxis = {};

    <span class="hljs-keyword">if</span> (!groupFieldIsDateTime) {
      xaxis.tickFormatter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>convert x to a string and make sure that it is not too long or the
tick labels will overlap
TODO: find a more accurate way of calculating the size of tick labels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> label = self._xaxisLabel(x) || <span class="hljs-string">""</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> label !== <span class="hljs-string">'string'</span>) {
          label = label.toString();
        }
        <span class="hljs-keyword">if</span> (self.state.attributes.graphType !== <span class="hljs-string">'bars'</span> &amp;&amp; label.length &gt; <span class="hljs-number">10</span>) {
          label = label.slice(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>) + <span class="hljs-string">"..."</span>;
        }

        <span class="hljs-keyword">return</span> label;
      };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>for labels case we only want ticks at the label intervals
HACK: however we also get this case with Date fields. In that case we
could have a lot of values and so we limit to max 15 (we assume)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xvaluesAreIndex) {
      <span class="hljs-keyword">var</span> numTicks = <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.model.records.length, <span class="hljs-number">15</span>);
      <span class="hljs-keyword">var</span> increment = <span class="hljs-keyword">this</span>.model.records.length / numTicks;
      <span class="hljs-keyword">var</span> ticks = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;numTicks; i++) {
        ticks.push(<span class="hljs-built_in">parseInt</span>(i*increment, <span class="hljs-number">10</span>));
      }
      xaxis.ticks = ticks;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (groupFieldIsDateTime) {
      xaxis.mode = <span class="hljs-string">'time'</span>;
    }

    <span class="hljs-keyword">var</span> yaxis = {};
    yaxis.autoscale = <span class="hljs-literal">true</span>;
    yaxis.autoscaleMargin = <span class="hljs-number">0.02</span>;

    <span class="hljs-keyword">var</span> legend = {};
    legend.position = <span class="hljs-string">'ne'</span>;

    <span class="hljs-keyword">var</span> grid = {};
    grid.hoverable = <span class="hljs-literal">true</span>;
    grid.clickable = <span class="hljs-literal">true</span>;
    grid.borderColor = <span class="hljs-string">"#aaaaaa"</span>;
    grid.borderWidth = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">var</span> optionsPerGraphType = {
      lines: {
        legend: legend,
        colors: <span class="hljs-keyword">this</span>.graphColors,
        lines: { show: <span class="hljs-literal">true</span> },
        xaxis: xaxis,
        yaxis: yaxis,
        grid: grid
      },
      points: {
        legend: legend,
        colors: <span class="hljs-keyword">this</span>.graphColors,
        points: { show: <span class="hljs-literal">true</span>, hitRadius: <span class="hljs-number">5</span> },
        xaxis: xaxis,
        yaxis: yaxis,
        grid: grid
      },
      <span class="hljs-string">'lines-and-points'</span>: {
        legend: legend,
        colors: <span class="hljs-keyword">this</span>.graphColors,
        points: { show: <span class="hljs-literal">true</span>, hitRadius: <span class="hljs-number">5</span> },
        lines: { show: <span class="hljs-literal">true</span> },
        xaxis: xaxis,
        yaxis: yaxis,
        grid: grid
      },
      bars: {
        legend: legend,
        colors: <span class="hljs-keyword">this</span>.graphColors,
        lines: { show: <span class="hljs-literal">false</span> },
        xaxis: yaxis,
        yaxis: xaxis,
        grid: grid,
        bars: {
          show: <span class="hljs-literal">true</span>,
          horizontal: <span class="hljs-literal">true</span>,
          shadowSize: <span class="hljs-number">0</span>,
          align: <span class="hljs-string">'center'</span>,
          barWidth: <span class="hljs-number">0.8</span>
        }
      },
      columns: {
        legend: legend,
        colors: <span class="hljs-keyword">this</span>.graphColors,
        lines: { show: <span class="hljs-literal">false</span> },
        xaxis: xaxis,
        yaxis: yaxis,
        grid: grid,
        bars: {
          show: <span class="hljs-literal">true</span>,
          horizontal: <span class="hljs-literal">false</span>,
          shadowSize: <span class="hljs-number">0</span>,
          align: <span class="hljs-string">'center'</span>,
          barWidth: <span class="hljs-number">0.8</span>
        }
      }
    };

    <span class="hljs-keyword">if</span> (self.state.get(<span class="hljs-string">'graphOptions'</span>)) {
      <span class="hljs-keyword">return</span> _.extend(optionsPerGraphType[typeId],
                      self.state.get(<span class="hljs-string">'graphOptions'</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> optionsPerGraphType[typeId];
    }
  },

  _groupFieldIsDateTime: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> xfield = <span class="hljs-keyword">this</span>.model.fields.get(<span class="hljs-keyword">this</span>.state.attributes.group);
    <span class="hljs-keyword">var</span> xtype = xfield.get(<span class="hljs-string">'type'</span>);
    <span class="hljs-keyword">var</span> isDateTime = (xtype === <span class="hljs-string">'date'</span> || xtype === <span class="hljs-string">'date-time'</span> || xtype  === <span class="hljs-string">'time'</span>);
    <span class="hljs-keyword">return</span> isDateTime;
  },

  createSeries: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    self.xvaluesAreIndex = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> series = [];
    <span class="hljs-keyword">var</span> xfield = self.model.fields.get(self.state.attributes.group);
    <span class="hljs-keyword">var</span> isDateTime = self._groupFieldIsDateTime();

    _.each(<span class="hljs-keyword">this</span>.state.attributes.series, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span> </span>{
      <span class="hljs-keyword">var</span> points = [];
      <span class="hljs-keyword">var</span> fieldLabel = self.model.fields.get(field).get(<span class="hljs-string">'label'</span>);

        <span class="hljs-keyword">if</span> (isDateTime){
            <span class="hljs-keyword">var</span> cast = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{
                <span class="hljs-keyword">var</span> _date = moment(<span class="hljs-built_in">String</span>(x));
                <span class="hljs-keyword">if</span> (_date.isValid()) {
                    x = _date.toDate().getTime();
                }
                <span class="hljs-keyword">return</span> x
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> raw = _.map(self.model.records.models,
                            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc, index)</span></span>{
                                <span class="hljs-keyword">return</span> doc.getFieldValueUnrendered(xfield)
                            });

            <span class="hljs-keyword">if</span> (_.all(raw, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> !<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(x)) })){
                <span class="hljs-keyword">var</span> cast = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(x) }
            } <span class="hljs-keyword">else</span> {
                self.xvaluesAreIndex = <span class="hljs-literal">true</span>
            }
        }

      _.each(self.model.records.models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc, index)</span> </span>{
        <span class="hljs-keyword">if</span>(self.xvaluesAreIndex){
            <span class="hljs-keyword">var</span> x = index;
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">var</span> x = cast(doc.getFieldValueUnrendered(xfield));
        }

        <span class="hljs-keyword">var</span> yfield = self.model.fields.get(field);
        <span class="hljs-keyword">var</span> y = <span class="hljs-built_in">parseFloat</span>(doc.getFieldValueUnrendered(yfield));

        <span class="hljs-keyword">if</span> (self.state.attributes.graphType == <span class="hljs-string">'bars'</span>) {
          points.push([y, x]);
        } <span class="hljs-keyword">else</span> {
          points.push([x, y]);
        }
      });
      series.push({
        data: points,
        label: fieldLabel,
        hoverable: <span class="hljs-literal">true</span>
      });
    });
    <span class="hljs-keyword">return</span> series;
  }
});

my.FlotControls = Backbone.View.extend({
  className: <span class="hljs-string">"editor"</span>,
  template: <span class="hljs-string">' \
  &lt;div class="editor"&gt; \
    &lt;form class="form-stacked"&gt; \
      &lt;div class="clearfix"&gt; \
        &lt;div class="form-group"&gt; \
          &lt;label&gt;Graph Type&lt;/label&gt; \
          &lt;div class="input editor-type"&gt; \
            &lt;select class="form-control"&gt; \
              &lt;option value="lines-and-points"&gt;Lines and Points&lt;/option&gt; \
              &lt;option value="lines"&gt;Lines&lt;/option&gt; \
              &lt;option value="points"&gt;Points&lt;/option&gt; \
              &lt;option value="bars"&gt;Bars&lt;/option&gt; \
              &lt;option value="columns"&gt;Columns&lt;/option&gt; \
            &lt;/select&gt; \
          &lt;/div&gt; \
        &lt;/div&gt; \
        &lt;div class="form-group"&gt; \
          &lt;label&gt;Group Column (Axis 1)&lt;/label&gt; \
          &lt;div class="input editor-group"&gt; \
            &lt;select class="form-control"&gt; \
              &lt;option value=""&gt;Please choose ...&lt;/option&gt; \
                {{#fields}} \
              &lt;option value="{{id}}"&gt;{{label}}&lt;/option&gt; \
                {{/fields}} \
            &lt;/select&gt; \
          &lt;/div&gt; \
        &lt;/div&gt; \
        &lt;div class="editor-series-group"&gt; \
        &lt;/div&gt; \
      &lt;/div&gt; \
      &lt;div class="editor-buttons"&gt; \
        &lt;button class="btn btn-default editor-add"&gt;Add Series&lt;/button&gt; \
      &lt;/div&gt; \
      &lt;div class="editor-buttons editor-submit" comment="hidden temporarily" style="display: none;"&gt; \
        &lt;button class="editor-save"&gt;Save&lt;/button&gt; \
        &lt;input type="hidden" class="editor-id" value="chart-1" /&gt; \
      &lt;/div&gt; \
    &lt;/form&gt; \
  &lt;/div&gt; \
'</span>,
  templateSeriesEditor: <span class="hljs-string">' \
    &lt;div class="editor-series js-series-{{seriesIndex}}"&gt; \
      &lt;div class="form-group"&gt; \
        &lt;label&gt;Series &lt;span&gt;{{seriesName}} (Axis 2)&lt;/span&gt; \
          [&lt;a href="#remove" class="action-remove-series"&gt;Remove&lt;/a&gt;] \
        &lt;/label&gt; \
        &lt;div class="input"&gt; \
          &lt;select class="form-control"&gt; \
          {{#fields}} \
          &lt;option value="{{id}}"&gt;{{label}}&lt;/option&gt; \
          {{/fields}} \
          &lt;/select&gt; \
        &lt;/div&gt; \
      &lt;/div&gt; \
    &lt;/div&gt; \
  '</span>,
  events: {
    <span class="hljs-string">'change form select'</span>: <span class="hljs-string">'onEditorSubmit'</span>,
    <span class="hljs-string">'click .editor-add'</span>: <span class="hljs-string">'_onAddSeries'</span>,
    <span class="hljs-string">'click .action-remove-series'</span>: <span class="hljs-string">'removeSeries'</span>
  },

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'render'</span>);
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.model.fields, <span class="hljs-string">'reset add'</span>, <span class="hljs-keyword">this</span>.render);
    <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">new</span> recline.Model.ObjectState(options.state);
    <span class="hljs-keyword">this</span>.render();
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> tmplData = <span class="hljs-keyword">this</span>.model.toTemplateJSON();
    <span class="hljs-keyword">var</span> htmls = Mustache.render(<span class="hljs-keyword">this</span>.template, tmplData);
    <span class="hljs-keyword">this</span>.$el.html(htmls);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>set up editor from state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'graphType'</span>)) {
      <span class="hljs-keyword">this</span>._selectOption(<span class="hljs-string">'.editor-type'</span>, <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'graphType'</span>));
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'group'</span>)) {
      <span class="hljs-keyword">this</span>._selectOption(<span class="hljs-string">'.editor-group'</span>, <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'group'</span>));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>ensure at least one series box shows up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> tmpSeries = [<span class="hljs-string">""</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'series'</span>).length &gt; <span class="hljs-number">0</span>) {
      tmpSeries = <span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'series'</span>);
    }
    _.each(tmpSeries, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(series, idx)</span> </span>{
      self.addSeries(idx);
      self._selectOption(<span class="hljs-string">'.editor-series.js-series-'</span> + idx, series);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Private: Helper function to select an option from a select list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _selectOption: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id,value)</span></span>{
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>.$el.find(id + <span class="hljs-string">' select &gt; option'</span>);
    <span class="hljs-keyword">if</span> (options) {
      options.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opt)</span></span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value == value) {
          $(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'selected'</span>,<span class="hljs-string">'selected'</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      });
    }
  },

  onEditorSubmit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">var</span> select = <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.editor-group select'</span>);
    <span class="hljs-keyword">var</span> $editor = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> $series = <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.editor-series select'</span>);
    <span class="hljs-keyword">var</span> series = $series.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> $(<span class="hljs-keyword">this</span>).val();
    });
    <span class="hljs-keyword">var</span> updatedState = {
      series: $.makeArray(series),
      group: <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.editor-group select'</span>).val(),
      graphType: <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.editor-type select'</span>).val()
    };
    <span class="hljs-keyword">this</span>.state.set(updatedState);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Public: Adds a new empty series select box to the editor.</p>
<p>@param [int] idx index of this series in the list of series</p>
<p>Returns itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addSeries: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(idx)</span> </span>{
    <span class="hljs-keyword">var</span> data = _.extend({
      seriesIndex: idx,
      seriesName: <span class="hljs-built_in">String</span>.fromCharCode(idx + <span class="hljs-number">64</span> + <span class="hljs-number">1</span>)
    }, <span class="hljs-keyword">this</span>.model.toTemplateJSON());

    <span class="hljs-keyword">var</span> htmls = Mustache.render(<span class="hljs-keyword">this</span>.templateSeriesEditor, data);
    <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'.editor-series-group'</span>).append(htmls);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  _onAddSeries: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    e.preventDefault();
    <span class="hljs-keyword">this</span>.addSeries(<span class="hljs-keyword">this</span>.state.get(<span class="hljs-string">'series'</span>).length);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Public: Removes a series list item from the editor.</p>
<p>Also updates the labels of the remaining series elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeSeries: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{
    e.preventDefault();
    <span class="hljs-keyword">var</span> $el = $(e.target);
    $el.parent().parent().remove();
    <span class="hljs-keyword">this</span>.onEditorSubmit();
  }
});

})(jQuery, recline.View);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
