/*! recline.deeplink v0.1 */
this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},this.recline.DeepLink.Deps=this.recline.DeepLink.Deps||{},function(a,b,c){"use strict";c.Map=function(a,c){var d=this;d.name="map",d.alterState=function(b){return"map"===b.currentView&&(b[d.name]={bounds:a.getBounds()}),b},d.updateUrl=function(){c.onStateChange(null)},d.update=function(c){if(a&&c&&c.map){var d=b.map(b.values(c.map.bounds),b.values);setTimeout(a.fitBounds.bind(a,d),0)}},a.on("dragend",d.updateUrl),a.on("zoomend",d.updateUrl)}}(jQuery,_,this.recline.DeepLink.Deps),this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},function(a,b){"use strict";b.Router=function(a){function c(a){var b=_.rest(_.toArray(arguments));return function(c){return _.isFunction(c[a])&&c[a].apply(c,b)}}var d,e=this,f=new b.Parser,g=DeepDiff.noConflict(),h=_.omit(JSON.parse(JSON.stringify(a.state)),"dataset"),i={},j={};_.extend(e,Backbone.Events),e.updateState=function(b){var d=e.transform(b,e.toState);_.each(j,c("update",d)),d&&!_.isEmpty(d)?(d=_.extend(a.state.attributes,d),a.model.queryState.set(d.query),a.updateNav(d.currentView||"grid"),_.each(a.pageViews,function(b,c){var e="view-"+b.id,f=a.pageViews[c];f.view.state.set(d[e]),_.isFunction(f.view.redraw)&&"graph"===f.id?setTimeout(f.view.redraw,0):"grid"===f.id&&f.view.render()})):a.updateNav("grid"),e.trigger("init",{serializedState:b})},e.addDependency=function(a){j[a.name]=a},e.transform=function(a,b){var c;try{c=b(a)}catch(d){c=null}return c},e.toState=function(a){var b=f.inflate(decodeURI(a));return JSON.parse(b)},e.toParams=function(a){var b=JSON.stringify(_.omit(a.attributes,"dataset"));return f.compress(b)},e.onStateChange=function(){var b,c,f=g.diff(h,_.omit(a.state.attributes,"dataset")),j={};_.each(f,function(a){"E"===a.kind?e.createNestedObject(j,a.path,a.rhs):"A"===a.kind&&e.createNestedObject(j,a.path,a)}),b=new recline.Model.ObjectState,b.attributes=j,b.attributes=e.alterState(b.attributes),i=b,c=e.transform(b,e.toParams),d.navigate(c),e.updateControls(),e.trigger("stateChange",{serializedState:c,state:i})},e.alterState=function(a){if(_.isEmpty(j))return a;var b=_.compose.apply(null,_.without(_.map(j,function(a){return a.alterState}),void 0));return b(a)},e.createNestedObject=function(a,b,c){for(var d=_.clone(b),e=3===arguments.length?d.pop():!1,f=0;f<d.length;f++)a=a[d[f]]=a[d[f]]||{};return!e||_.isArray(c)||_.isObject(c)||(a=a[e]=c),_.isObject(c)&&"A"===c.kind&&(_.isUndefined(a[e])&&(a[e]=[]),"N"===c.item.kind&&(a=a[e][c.index]=c.item.rhs),"D"===c.item.kind&&(a[e].splice(c.index,c.item.rhs),a=a[e])),a},e.updateControls=function(){var b=a.state.get("currentView");if(a.pager.render(),"graph"===b||"map"===b){var c=e.getCurrentViewIndex(),d={graph:"editor",map:"menu"},f=d[b],g=a.pageViews[c].view[f],h=e.getCurrentView().view.state;g.state.set(h.attributes),g.render()}},e.getCurrentView=function(){var b=a.state.get("currentView");return _.findWhere(a.pageViews,{id:b})},e.getCurrentViewIndex=function(){var b,c=a.state.get("currentView");return _.each(a.pageViews,function(a,d){a.id===c&&(b=d)}),b},e.start=function(){var b=Backbone.Router.extend({routes:{"*state":"defaultRoute"},defaultRoute:function(a){e.updateState(a)}});d=new b,a.listenTo(a.state,"all",e.onStateChange),a.model.bind("all",e.onStateChange),Backbone.history.start()}},b.Parser=function(){var a=this;a.compress=function(b){return a.escapeStrings(b)},a.inflate=function(b){return a.parseStrings(b)},a.escapeStrings=function(a){return a=a.replace("%","@@"),a=a.replace(/"([a-zA-Z-_.]+)"\s?:/g,"$1:"),a=a.replace(/\x20(?![^"]*("[^"]*"[^"]*)*$)/g,"++"),a.replace(/"([a-zA-Z0-9-#_.-|+]+)?"/g,"!$1")},a.parseStrings=function(a){return a=a.replace("@@","%"),a=a.replace(/([{,])([a-zA-Z-_.\+]+)\s?:/g,'$1"$2":'),a=a.replace(/![a-zA-Z0-9_. -\+]+/g,function(a){return a.replace(/\+\+/g," ")}),a.replace(new RegExp("!([a-zA-Z0-9-_# .-:%]+)?","g"),'"$1"')}}}(jQuery,this.recline.DeepLink);