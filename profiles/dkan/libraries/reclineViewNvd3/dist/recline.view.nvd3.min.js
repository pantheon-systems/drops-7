/*! recline.view.nvd3 v0.3.0 */
this.recline=this.recline||{},this.recline.View=this.recline.View||{},this.recline.View.nvd3=this.recline.View.nvd3||{};var globalchart,chartAxes=["x","y","y1","y2"];!function(a,b){"use strict";function c(a){return(a=a||"")+(1e16*Math.random()).toFixed(0)}b.Base=Backbone.View.extend({template:'<div class="recline-graph recline-nvd3 row">{{data}}<div class="{{columnClass}} {{viewId}} recline-nvd3"style="display: block;"><div id="{{viewId}}" class="recline-nvd3"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" style="height:{{height}}px;width: 100%;"></svg></div></div></div> ',CLEANUP_CHARS:"%$¥€",initialize:function(b){var d=this;d.$el=a(d.el),d.options=_.defaults(b||{},d.options);var e=_.merge({width:640,group:!1},d.getDefaults(),d.options.state.toJSON());d.graphType=d.graphType||"multiBarChart",d.uuid=c("nvd3chart_"),d.state=d.options.state,d.model=d.options.model,d.state.set(e),d.chartMap=d3.map(),d.listenTo(d.model.records,"add remove reset change",d.lightUpdate.bind(d)),globalchart=d},getLayoutParams:function(){var a=this;return{columnClass:"col-md-12",width:a.state.get("width")||a.$el.innerWidth()||640,height:a.state.get("chartHeight")||480}},render:function(){var a,b,c,d=this;d.listenToOnce(d.state,"change",d.render.bind(d)),c=d.getLayoutParams(),a=d.model.toTemplateJSON(),a.viewId=d.uuid,_.extend(a,c),b=Mustache.render(d.template,a),d.$el.html(b),d.$graph=d.$el.find(".panel."+a.viewId),d.trigger("chart:endDrawing");var e=d.needForceX(d.model.records,d.graphType);return d.state.set("computeXLabels",e,{silent:!0}),d.state.set("group",d.model.records.length>1e3||d.state.get("group",{silent:!0})),d.series=d.createSeries(d.model.records),nv.addGraph(function(){return d.chart=d.createGraph(d.graphType),d.alterChart&&d.alterChart(d.chart),chartAxes.forEach(function(a){if(d.chart[a+"Axis"]){var b=d.state.get(a+"Format")||{type:"String",format:""},c=d.getFormatter(b.type,b.format,a);d.calcTickValues(a,d.chart[a+"Axis"],d.state.get(a+"Values"),d.state.get(a+"ValuesStep")),d.chart[a+"Axis"].tickFormat(c)}}),d3.select("#"+d.uuid+" svg").datum(d.series).transition().duration(d.state.get("transitionTime")||500).call(d.chart),d.renderGoals(),"discreteBarChart"===d.graphType&&d.state.get("options")&&d.state.get("options").reduceXTicks&&d.reduceXTicks(),"function"==typeof d.chart.tooltips?d.chart.tooltips(d.state.get("options").tooltips):d.chart.tooltip.enabled(d.state.get("options").tooltips),nv.utils.windowResize(d.updateChart.bind(d)),d.chart}),d},calcTickValues:function(a,b,c,d){var e,f=this,g=["multiBarChart","discreteBarChart","linePlusBarChart"];d=d||1,this.isOldRangeType(c)&&(c=this.convertRange(c)),c&&f.rangesValid(c)&&(c[0]=parseInt(c[0]),c[1]=parseInt(c[1]),e=d3.range(c[0],c[1],d),"linePlusBarChart"===f.graphType&&"y1"===a?f.chart.bars.yDomain([c[0],c[1]],d):"linePlusBarChart"===f.graphType&&"y2"===a?f.chart.lines.yDomain([c[0],c[1]],d):_.inArray(g,f.graphType)&&"y"!==a?f.chart[a+"Domain"](d3.range(c[0],c[1],d)):f.chart[a+"Domain"]([c[0],c[1]])),b.tickValues(e)},isOldRangeType:function(a){return a&&-1!==a.indexOf("-")},convertRange:function(a){for(var b=a.replace(" ","").split("-"),c=0;c<a.length;c++)""===b[c]&&c<b.length&&(b[c+1]="-"+b[c+1]);var d=[];for(c=0;c<b.length;c++)""!==b[c]&&d.push(parseFloat(b[c]));return d=d.sort(function(a,b){return a-b})},rangesValid:function(a){var b=!0;return a&&2===a.length||(b=!1),_.each(a,function(a){a&&!isNaN(parseInt(a))||(b=!1)}),b&&parseInt(a[0])>=parseInt(a[1])&&(b=!1),b},lightUpdate:function(){var a=this;a.chart&&(a.series=a.createSeries(a.model.records),a.setOptions(a.chart,a.state.get("options")),setTimeout(function(){d3.select("#"+a.uuid+" svg").datum(a.series).transition().duration(500).call(a.chart)},0))},canRenderGoal:function(a){return!d3.select("svg").empty()&&d3.select("svg .goal").empty()&&a&&a.value&&!isNaN(a.value)&&this.chart.yAxis},renderGoals:function(){var a=this,b=a.state.get("goal");nv.dispatch.on("render_end",null),this.canRenderGoal(b)&&nv.dispatch.on("render_end",function(){var c,d,e=a.chart.yAxis.scale(),f=a.chart.margin(),g=e(b.value)+f.top,h=f.left,i=d3.select("svg").size()?parseInt(d3.select("svg").style("width"))-10:0,j=d3.select("svg").append("g");b.label&&(b.outside?(c=h-50,d=g+3):(c=h+5,d=g-6),j.append("text").text("TARGET").attr("x",c).attr("y",d).attr("fill",b.color||"red").style("font-size","10px").style("font-weight","bold").style("font-style","italic")),j.append("line").attr("class","goal").attr("x1",h).attr("y1",g).attr("x2",i).attr("y2",g).attr("stroke-width",1).attr("stroke",b.color||"red").style("stroke-dasharray","3, 3")})},updateChart:function(){var a=this;d3.select("#"+a.uuid+" svg").transition().duration(a.state.get("transitionTime")||500).call(a.chart)},reduceXTicks:function(){var a=this,b=a.getLayoutParams(a.state.get("mode"));d3.select(".nv-x.nv-axis > g").selectAll("g").filter(function(c,d){return d%Math.ceil(a.model.records.length/(b.width/100))!=0}).selectAll("text, line").style("opacity",0)},createSeries:function(a){var b,c,d=this;return d.state.get("xfield")&&d.getSeries()?(a=a.toJSON(),b=_.compose(_.inferType,_.iteratee(d.state.get("xfield"))),c=d.state.get("xDataType")&&"Auto"!==d.state.get("xDataType")?d.state.get("xDataType"):b(_.last(a)||[]),_.map(d.getSeries(),function(b){var e={};e.key=b;var f=d.state.get("group")?_.reportBy(a,d.state.get("xfield"),d.state.get("seriesFields")):a;return f=_.sortBy(f,d.getSort(d.state.get("sort"))),f=_.reduce(f,function(a,c){var e=d.cleanupY(d.y(c,b));return e||0===e||"stackedAreaChart"===d.graphType?a.push(c):d.state.get("options").stacked&&(c[b]=0,a.push(c)),a},[]),e.values=_.map(f,function(a,e){var f=d.cleanupY(d.y(a,b));return f=d.state.get("yDataType")&&"Number"===d.state.get("yDataType")?numeral(f).value():_.cast(f,_.inferType(f)),d.state.get("computeXLabels")?(d.chartMap.set(e,d.x(a,d.state.get("xfield"))),{y:f,x:e,label:d.x(a,d.state.get("xfield"))}):{y:f,x:_.cast(d.x(a,d.state.get("xfield")),c)}}),e})):[]},cleanupY:function(a){var b=this;return"string"==typeof a?a.replace(new RegExp("["+b.CLEANUP_CHARS+"]"),""):a},getSort:function(a){return a&&"default"!==a?a:_.identity},needForceX:function(a,b){var c=this,d=c.state.get("xfield");return a=a.toJSON(),_.some(a,function(a){return"String"===_.inferType(a[d])})&&"discreteBarChart"!==b&&"multiBarChart"!==b},getFormatter:function(a,b,c){var d=this;return c=c||"x",d.state.get("computeXLabels")&&"x"===c?d.chartMap.get.bind(d.chartMap):{String:_.identity,Date:_.compose(d3.time.format(b||"%x"),_.instantiate(Date)),Number:d3.format(b||".02f"),Percentage:function(a){return d3.format(b||".02f")(100*a)+"%"},PercentageA:function(a){return d3.format(b||".02f")(a)+"%"}}[a]},setOptions:function(a,b){var c=this;for(var d in b){var e=b[d];"margin"===d&&(e.top=0,a.margin(e)),a&&_.isObject(e)&&!_.isArray(e)?c.setOptions(a[d],e):a&&_.isFunction(a[d])&&a[d](e)}},createGraph:function(a){var b=this,c=nv.models[a]();return b.setOptions(c,b.state.get("options")),c},getDefaults:function(){return{}},getState:function(){return this.state.attributes},getSeries:function(){return this.state.get("seriesFields")},x:function(a,b){return a[b]},y:function(a,b){return a[b]},destroy:function(){this.stopListening()},alterChart:function(){}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.cumulativeLineChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="cumulativeLineChart",recline.View.nvd3.Base.prototype.initialize.call(b,a)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){return{useInteractiveGuideline:!0,tooltips:!0}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.discreteBarChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="discreteBarChart",recline.View.nvd3.Base.prototype.initialize.call(b,a)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){return{computeXLabels:!1,options:{tooltips:!0}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.lineChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="lineChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!0)},render:function(){var b=this;recline.View.nvd3.Base.prototype.render.call(b,{}),b.state.get("options").datapoints&&a(".recline-graph").addClass("recline-show-datapoints")},getDefaults:function(){var a=this;return{options:{useInteractiveGuideline:!1,tooltips:!0,xAxis:{tickFormat:function(b){return a.chartMap?a.chartMap.get(b):b}}}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.linePlusBarChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="linePlusBarChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!0)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},alterChart:function(b){var c=this;b.x(function(a,b){return b}).y(function(a,b){return a.y}),b.options({focusEnable:!1});var d=0,e=c.state.get("lpbBarChartField")||a("#control-lpb-barchart-field").val();c.series.forEach(function(a,b){a.originalKey&&(a.key=a.originalKey,delete a.originalKey),delete a.bar,a.key!==e&&a.originalKey!==e||(d=b)}),c.series[d].bar=!0},getDefaults:function(){return{options:{tooltips:!0,showLegend:!0}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.lineWithFocusChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="lineWithFocusChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!0)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){var a=this;return{options:{tooltips:!0,xAxis:{tickFormat:function(b){return a.chartMap?a.chartMap.get(b):b}}}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.multiBarChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="multiBarChart",recline.View.nvd3.Base.prototype.initialize.call(b,a)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{}),nv.dispatch.on("render_end",function(){d3.selectAll(".nv-controlsWrap .nv-legend .nv-series").on("click",function(b){var c="Stacked"===b.key;a.state.get("options").stacked=c,a.lightUpdate(),a.chart.stacked(c)})})},getDefaults:function(){return{computeXLabels:!1,options:{reduceXTicks:!0,tooltips:!0}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.multiBarHorizontalChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="multiBarHorizontalChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!1)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){return{options:{tooltips:!0,reduceXTicks:!1}}},renderGoals:function(){var a=this,b=a.state.get("goal");nv.dispatch.on("render_end",null),this.canRenderGoal(b)&&nv.dispatch.on("render_end",function(){var c,d,e=a.chart.yAxis.scale(),f=a.chart.margin(),g=e(b.value)+f.left,h=f.top,i=jQuery("g").get(0).getBBox().height,j=d3.select("svg").append("g");b.label&&(c=g+5,d=h+5,j.append("text").text(b.title||"TARGET").attr("x",c).attr("y",d).attr("fill",b.color||"red").style("font-size","10px").style("font-weight","bold").style("font-style","italic")),j.append("line").attr("class","goal").attr("y1",h).attr("x1",g).attr("y2",i-5).attr("x2",g).attr("stroke-width",1).attr("stroke",b.color||"red").style("stroke-dasharray","3, 3")})}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.pieChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="pieChart",recline.View.nvd3.Base.prototype.initialize.call(b,a)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},alterChart:function(a){this.series.length>10&&a.showLegend(!1)},createSeries:function(a){var b=this;a=a.toJSON();var c=_.first(b.state.get("seriesFields"));return a=b.state.get("group")?_.reportBy(a,b.state.get("xfield"),b.state.get("seriesFields")):a,_.map(a,function(a){return{y:b.cleanupY(b.y(a,c)),x:b.x(a,b.state.get("xfield"))}})},getDefaults:function(){return{options:{showLabels:!0,labelType:"percent",tooltips:!0}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.scatterChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="scatterChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!0)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){var a=this;return{options:{showDistX:!0,showDistY:!0,onlyCircles:!1,xAxis:{tickFormat:function(b){return a.chartMap?a.chartMap.get(b):b}}}}}})}(jQuery,recline.View.nvd3),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";b.stackedAreaChart=recline.View.nvd3.Base.extend({initialize:function(a){var b=this;b.graphType="stackedAreaChart",recline.View.nvd3.Base.prototype.initialize.call(b,a),b.state.set("computeXLabels",!0)},render:function(){var a=this;recline.View.nvd3.Base.prototype.render.call(a,{})},getDefaults:function(){return{options:{useInteractiveGuideline:!0,tooltips:!0,xAxis:{tickFormat:function(a){return d3.time.format("%Y")(new Date(a))}}}}}})}(jQuery,recline.View.nvd3),jQuery(function(){"use strict";_.mixin({getFields:function(a){var b=[];try{b=_.pluck(a.fields.toJSON(),"id")}catch(a){console.error("Error retrieving dataset fields")}return b},applyOption:function(a,b){return _.map(a,function(a){return a.selected=!!_.inArray(b,a.value),a})},arrayToOptions:function(a){return _.map(a,function(a){return{name:a,value:a,selected:!1}})}})});