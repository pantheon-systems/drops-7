<?php

/**
 * @file
 * Code for the Menu Block Beans feature.
 */

include_once 'webform_block_beans.features.inc';

/**
 * Implements hook_form_alter().
 */
function webform_block_beans_form_alter(&$form, &$form_state, $form_id) {
  if (!isset($form['#node_edit_form'])) {
    return;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Extendes the webform_blocks add/edit page to add a new title field.
 */
function webform_block_beans_form_webform_configure_form_alter(&$form, $form_state) {
  
  // Rename "title" to "label" for more consistancy.
  //$form['title']['#title'] = t('Label');
  //$form['title']['#description'] = t('The Webform Block label is only visible within the administration UI. It will not be shown to users.');

  // Add "title" field.
  $form['advanced']['webform_block_beans_title'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#weight' => -8,
    '#description' => t('The Webform Block title will appear above the webform_blocks. Leave blank for none.'),
  );

  // Populate our new "title" field with a default_value from the bean title.
  $bean = bean_load_delta($form['machine_name']['#default_value']);
  if (!empty($bean->title)) {
    $form['webform_block_beans_title']['#default_value'] = $bean->title;
  }

  // Add a form submit to update the bean title with the 'webform_block_beans_title' value.
  $form['#submit'][] = 'webform_block_beans_form_webform_blocks_submit';
}

/**
 * Submit handler for webform_blocks_form.
 *
 * Processes our new 'webform_block_beans_title' field and saves it to the bean.
 */
function webform_block_beans_form_webform_blocks_submit($form, $form_state) {
  //$bean = bean_load_delta($form_state['values']['machine_name']);
  //if (!empty($bean)) {
    //$bean->title = $form_state['values']['webform_block_beans_title'];
    //bean_save($bean);
  //}
}

/**
 * Implements hook_node_insert().
 *
 * Create a bean each time a webform_block is created.
 */
 // webform blocks are created with webform_node_insert or webform_node_update
function webform_block_beans_node_insert($node) {
  
  //webform option to create block only exists after the node is 
  // created... can only be in update
  //if ($node->type == 'webform') {
    //dsm($node);
    //client-block-
    //_webform_block_beans_create_bean($webform_block);
  //}
}


/**
 * Implements hook_webform_blocks_update().
 *
 * Create a bean if there isn't one already.
 */
function webform_block_beans_node_update($node) {
  if ($node->type == 'webform' && $node->webform['block']) {
    $machine_name = 'client-block-' . $node->nid;
    $bean = bean_load_delta($machine_name);
    if (!is_object($bean)) {     
      _webform_block_beans_create_bean($machine_name, $node->title);
    }
  }
}

/**
 * Implements hook_webform_blocks_delete().
 *
 * Removes the associated bean when deleting a webform_block.
 */
function webform_block_beans_webform_blocks_delete($node) {
  if ($node->type == 'webform') {
    $bean = bean_load_delta($machine_name);
    if (is_object($bean)) {
      bean_delete($bean);
    }
  }
}

/**
 * Creates a bean of type 'webform_block' from a given webform_block instance.
 */
function _webform_block_beans_create_bean($machinename, $title) {
  $bean = bean_create(array('type' => 'webform_block'));
  $bean->label = 'Webform Block: ' . $title;
  $bean->title = $title;
  $bean->delta = $machinename;
  $bean->save();
}

/**
 * Implements hook_entity_view_alter().
 *
 * Renders a webform_block within a webform_block bean type.
 */
function webform_block_beans_entity_view_alter(&$build, $type) {
  if ($type == 'bean' && $build['#bundle'] == 'webform_block') {
    //dsm('webform_block_beans_entity_view_alter');
    //dsm($build);
    $build['webform_block'] = webform_block_view($build['#entity']->delta);
  }
}

/**
 * Implements hook_FORM_ID_form_alter().
 *
 * Disables auto-populated bean label/title fields on bean configuration form
 * for webform_block beans.
 */
function webform_block_beans_form_bean_form_alter(&$form, &$form_state) {
  if ($form['#bundle'] == 'webform_block') {
    $form['mb_beans_help'] = array(
      '#markup' => t('These fields are automatically populated from the webform_block instance: !link', array(
        '!link' => l($form['bean']['#value']->delta, 'admin/structure/webform_blocks/manage/' . $form['bean']['#value']->delta . '/edit'))
      ),
      '#weight' => -99,
    );
    $form['label']['#disabled'] = TRUE;
    $form['title']['#disabled'] = TRUE;
  }
}

function webform_block_beans_get_blocks() {
  // borrowed from webform_admin_content
  
  $query = db_select('webform', 'w');
  $query->join('node', 'n', 'w.nid = n.nid');
  $query->fields('n');
  $query->condition('block', 1,'=');
  
  return $query->execute()->fetchAllAssoc('nid');
}
